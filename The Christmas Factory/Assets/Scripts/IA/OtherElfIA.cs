using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class OtherElfIA : MonoBehaviour
{
    [SerializeField] List<Transform> path = new List<Transform>();

    [SerializeField]
    private ElfActionsManager myActionsManager = null;

    [SerializeField]
    private bool isWorking = true;
    public bool IsWorking { get { return isWorking; } }

    [SerializeField]
    private float breakGap = 1f;

    void Start()
    {
        myActionsManager = GetComponent<ElfActionsManager>();
    }

    // Update is called once per frame
    void Update()
    {
        if (!myActionsManager.MyElfAnimation.InAction)
        {
            myActionsManager.ToyWrapping();
        }

        if (myActionsManager.MyConveyor.IsInBreak && isWorking)
        {
            isWorking = false;
            StartCoroutine(BreakBehaviour());
        }
    }

    private IEnumerator BreakBehaviour()
    {
        float myBreakTime = myActionsManager.MyConveyor.BreakTime - breakGap;
        for (int i = 0; i < path.Count; i++)
        {
            Vector3 startPosition = transform.position;
            Vector3 endPosition = path[i].transform.position;
            Vector3 direction = endPosition - startPosition;
            myActionsManager.MyElfAnimation.SlideIdle();
            myActionsManager.MyElfAnimation.Walking(direction.x, direction.y);
            float travelPercent = 0f;
            while (travelPercent < 1f)
            {
                travelPercent += Time.deltaTime * myActionsManager.ElfData.WalkSpeed;
                transform.position = Vector3.Lerp(startPosition, endPosition, travelPercent);
                yield return new WaitForEndOfFrame();
            }

            myActionsManager.MyElfAnimation.WalkingAnimator(false);
            myActionsManager.MyElfAnimation.FrontIdle();

            if ((i + 1) <= path.Count)
            {
                yield return new WaitForSeconds(myBreakTime);
            }
        }
        isWorking = true;
    }

    public bool ElfResponse()
    {
        myActionsManager.MyElfAnimation.AcctionAnimation("Talk");
        Invoke("HideCallout", myActionsManager.MyElfAnimation.AcctionDelay);
        if (myActionsManager.MyConveyor.IsInBreak)
        {
            myActionsManager.MyCalloutManager.SetCalloutSprite(CalloutTypes.Good);
            myActionsManager.MyCalloutManager.EnableCallout(true);
            return true;
        }
        else
        {
            myActionsManager.MyCalloutManager.SetCalloutSprite(CalloutTypes.Bad);
            myActionsManager.MyCalloutManager.EnableCallout(true);
            return false;
        }

    }


    private void HideCallout()
    {
        myActionsManager.MyCalloutManager.EnableCallout(false);
    }

}
